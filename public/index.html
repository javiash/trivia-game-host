<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trivia de Cumplea√±os</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="app"></div>

  <script>
    const socket = io();
    let gameState = {
      currentQuestion: '',
      isQuestionActive: false,
      responses: [],
      scores: {},
      questionNumber: 0,
      players: [],
      currentTurnIndex: 0
    };
    let mode = 'choose';
    let playerName = '';
    let hasResponded = false;
    let isHostAuthenticated = false;

    socket.on('gameState', (state) => {
      gameState = state;
      
      if (mode === 'player') {
        if (!gameState.isQuestionActive) {
          hasResponded = false;
        }
      }
      
      render();
    });

    function startQuestion(question) {
      socket.emit('startQuestion', question);
    }

    function endQuestion() {
      socket.emit('endQuestion');
    }

    function playerResponse() {
      if (!gameState.isQuestionActive || hasResponded) return;
      hasResponded = true;
      socket.emit('playerResponse', { name: playerName });
      render();
    }

    function markCorrect(name, points) {
      socket.emit('markCorrect', { name, points });
    }

    function markIncorrect(name) {
      socket.emit('markIncorrect', name);
    }

    function resetGame() {
      socket.emit('resetGame');
    }

    function render() {
      const app = document.getElementById('app');
      
      if (mode === 'choose') {
        app.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
              <div class="text-center mb-8">
                <div class="text-6xl mb-4">üèÜ</div>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">¬°Trivia de Cumplea√±os!</h1>
                <p class="text-gray-600">Elige tu rol para comenzar</p>
              </div>
              
              <div class="space-y-4">
                <button onclick="promptHostPassword()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-semibold text-lg hover:shadow-lg transform hover:scale-105 transition-all">
                  üé§ Soy el Anfitri√≥n
                </button>
                
                <button onclick="setMode('player')" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-4 rounded-xl font-semibold text-lg hover:shadow-lg transform hover:scale-105 transition-all">
                  üéÆ Soy un Jugador
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (mode === 'host') {
        if (!isHostAuthenticated) {
          renderHostLogin();
        } else {
          renderHost();
        }
      } else if (mode === 'player') {
        renderPlayer();
      }
    }

    function renderHost() {
      const sortedScores = Object.entries(gameState.scores).sort((a, b) => b[1] - a[1]);
      const waitingResponses = gameState.responses.filter(r => r.status === 'waiting');
      const correctCount = gameState.responses.filter(r => r.status === 'correct').length;
      
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 p-4">
          <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              
              <!-- Panel Principal -->
              <div class="lg:col-span-2 space-y-4">
                <div class="bg-white rounded-3xl shadow-2xl p-6">
                  <div class="flex items-center justify-between mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">üé§ Panel de Anfitri√≥n</h1>
                    <button onclick="setMode('choose')" class="px-4 py-2 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300">
                      Salir
                    </button>
                  </div>

                  <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">
                      Pregunta #${gameState.questionNumber + 1}
                    </label>
                    <div class="flex gap-2">
                      <button
                        onclick="launchQuestion()"
                        ${gameState.isQuestionActive ? 'disabled' : ''}
                        class="flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-semibold text-lg disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg transition-all"
                      >
                        ${gameState.isQuestionActive ? '‚è≥ Pregunta Activa' : 'üöÄ Iniciar Pregunta'}
                      </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Haz la pregunta verbalmente a los participantes</p>
                  </div>

                  ${gameState.currentQuestion ? `
                    <div class="mb-6 p-4 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl">
                      <div class="flex items-center justify-between">
                        <div class="flex-1">
                          <p class="text-lg font-bold text-gray-800">Pregunta #${gameState.questionNumber}</p>
                          <p class="text-sm text-gray-600 mt-1">${gameState.isQuestionActive ? 'En curso...' : 'Finalizada'}</p>
                        </div>
                        ${gameState.isQuestionActive ? `
                          <button
                            onclick="endQuestion()"
                            class="ml-4 px-6 py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600"
                          >
                            ‚ùå Cancelar Pregunta
                          </button>
                        ` : `
                          <span class="ml-4 px-6 py-3 bg-gray-400 text-white rounded-xl font-semibold">
                            ‚úì Cerrada
                          </span>
                        `}
                      </div>
                    </div>
                  ` : ''}

                  ${gameState.isQuestionActive ? `
                    <div class="mb-6">
                      <h3 class="text-lg font-bold text-gray-800 mb-3">‚ö° Orden de Respuestas</h3>
                      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                        <p class="text-sm text-gray-700">
                          <span class="font-semibold">Instrucciones:</span>
                        </p>
                        <ul class="text-sm text-gray-600 mt-1 ml-4 list-disc">
                          <li><strong>+2 pts</strong>: Respuesta directa sin opciones</li>
                          <li><strong>+1 pt</strong>: Respuesta con opciones m√∫ltiples</li>
                          <li><strong>‚úó</strong>: Respuesta incorrecta (pasa al siguiente)</li>
                        </ul>
                      </div>
                      ${gameState.responses.length === 0 ? `
                        <p class="text-gray-500 text-center py-4">Esperando respuestas...</p>
                      ` : `
                        <div class="space-y-2">
                          ${gameState.responses.map((response, index) => {
                            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∞`;
                            const isCurrentTurn = response.status === 'waiting' && index === gameState.responses.findIndex(r => r.status === 'waiting');
                            
                            return `
                              <div class="flex items-center gap-3 p-3 rounded-xl border-2 ${
                                response.status === 'correct' ? 'bg-green-100 border-green-400' :
                                response.status === 'incorrect' ? 'bg-red-100 border-red-400' :
                                isCurrentTurn ? 'bg-yellow-100 border-yellow-400 animate-pulse' :
                                'bg-gray-50 border-gray-300'
                              }">
                                <span class="text-2xl font-bold">${medal}</span>
                                <span class="font-semibold text-gray-800 flex-1">${response.name}</span>
                                
                                ${response.status === 'waiting' ? `
                                  ${isCurrentTurn ? `
                                    <span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded-full mr-2">ES SU TURNO</span>
                                    <div class="flex gap-2">
                                      <button
                                        onclick="markCorrect('${response.name}', 2)"
                                        class="px-4 py-2 bg-gradient-to-r from-green-600 to-green-500 text-white rounded-lg hover:shadow-lg font-semibold transform hover:scale-105 transition-all"
                                      >
                                        ‚úì +2 pts
                                      </button>
                                      <button
                                        onclick="markCorrect('${response.name}', 1)"
                                        class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-lg hover:shadow-lg font-semibold transform hover:scale-105 transition-all"
                                      >
                                        ‚úì +1 pt
                                      </button>
                                      <button
                                        onclick="markIncorrect('${response.name}')"
                                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold"
                                      >
                                        ‚úó
                                      </button>
                                    </div>
                                  ` : `
                                    <span class="text-sm text-gray-600">Esperando turno...</span>
                                  `}
                                ` : response.status === 'correct' ? `
                                  <span class="text-green-600 font-bold">‚úì CORRECTO</span>
                                ` : `
                                  <span class="text-red-600 font-bold">‚úó INCORRECTO</span>
                                `}
                              </div>
                            `;
                          }).join('')}
                        </div>
                      `}
                    </div>
                  ` : ''}
                </div>
              </div>

              <!-- Panel Lateral de Jugadores -->
              <div class="lg:col-span-1 space-y-4">
                <!-- Lista de Jugadores Activos -->
                <div class="bg-white rounded-3xl shadow-2xl p-6">
                  <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    üë• Jugadores Conectados
                  </h3>
                  ${gameState.players.length === 0 ? `
                    <p class="text-gray-500 text-center py-4 text-sm">No hay jugadores conectados</p>
                  ` : `
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                      ${gameState.players.map(player => `
                        <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
                          <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="font-semibold text-gray-800">${player}</span>
                          </div>
                          <span class="text-sm text-purple-600 font-bold">${gameState.scores[player] || 0} pts</span>
                        </div>
                      `).join('')}
                    </div>
                  `}
                </div>

                <!-- Tabla de Puntuaci√≥n -->
                <div class="bg-white rounded-3xl shadow-2xl p-6">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                      üèÜ Ranking
                    </h3>
                    <button
                      onclick="if(confirm('¬øReiniciar el juego y los puntos?')) resetGame()"
                      class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm"
                    >
                      Reiniciar
                    </button>
                  </div>
                  ${sortedScores.length === 0 ? `
                    <p class="text-gray-500 text-center py-4 text-sm">No hay puntuaciones a√∫n</p>
                  ` : `
                    <div class="space-y-2">
                      ${sortedScores.slice(0, 10).map(([name, score], index) => `
                        <div class="flex items-center gap-2 p-2 rounded-lg ${
                          index === 0 ? 'bg-gradient-to-r from-yellow-200 to-yellow-100' :
                          index === 1 ? 'bg-gradient-to-r from-gray-200 to-gray-100' :
                          index === 2 ? 'bg-gradient-to-r from-orange-200 to-orange-100' :
                          'bg-gray-50'
                        }">
                          <span class="text-lg font-bold w-6">${index + 1}</span>
                          <span class="font-semibold text-gray-800 flex-1 text-sm truncate">${name}</span>
                          <span class="text-lg font-bold text-purple-600">${score}</span>
                        </div>
                      `).join('')}
                    </div>
                  `}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderPlayer() {
      if (!playerName) {
        const app = document.getElementById('app');
        app.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-blue-600 via-cyan-500 to-teal-400 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
              <div class="text-center mb-6">
                <div class="text-6xl mb-4">üë§</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">¬°Bienvenido!</h2>
                <p class="text-gray-600">Ingresa tu nombre para jugar</p>
              </div>
              
              <input
                type="text"
                id="nameInput"
                placeholder="Tu nombre"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl mb-4 focus:border-blue-500 focus:outline-none text-lg"
              />
              
              <button
                onclick="submitName()"
                class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-3 rounded-xl font-semibold text-lg hover:shadow-lg transition-all"
              >
                Entrar al Juego
              </button>
              
              <button
                onclick="setMode('choose')"
                class="w-full mt-3 px-4 py-2 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300"
              >
                Volver
              </button>
            </div>
          </div>
        `;
        return;
      }

      const myResponse = gameState.responses.find(r => r.name === playerName);
      const myPosition = gameState.responses.findIndex(r => r.name === playerName) + 1;

      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-blue-600 via-cyan-500 to-teal-400 flex items-center justify-center p-4">
          <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800 mb-2">Hola, ${playerName}! üëã</h2>
              <button
                onclick="changeName()"
                class="text-sm text-gray-600 hover:text-gray-800"
              >
                Cambiar nombre
              </button>
            </div>

            ${!gameState.isQuestionActive && !gameState.currentQuestion ? `
              <div class="text-center py-8">
                <div class="text-6xl mb-4">‚ö°</div>
                <p class="text-gray-600 text-lg">Esperando la primera pregunta...</p>
              </div>
            ` : ''}

            ${gameState.currentQuestion ? `
              <div class="mb-6 p-4 bg-gradient-to-r from-blue-100 to-cyan-100 rounded-xl">
                <p class="text-sm text-gray-600 mb-2">Pregunta Actual:</p>
                <p class="text-xl font-bold text-gray-800">${gameState.currentQuestion}</p>
              </div>
            ` : ''}

            ${gameState.isQuestionActive ? (
              hasResponded && myResponse ? `
                <div class="text-center py-6">
                  <div class="w-20 h-20 ${
                    myResponse.status === 'correct' ? 'bg-green-500' :
                    myResponse.status === 'incorrect' ? 'bg-red-500' :
                    'bg-blue-500'
                  } rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-4xl">${
                      myResponse.status === 'correct' ? '‚úì' :
                      myResponse.status === 'incorrect' ? '‚úó' :
                      myPosition === 1 ? 'ü•á' : myPosition === 2 ? 'ü•à' : myPosition === 3 ? 'ü•â' : myPosition + '¬∞'
                    }</span>
                  </div>
                  <p class="text-xl font-bold text-gray-800 mb-2">
                    ${myResponse.status === 'correct' ? '¬°Respuesta Correcta!' :
                      myResponse.status === 'incorrect' ? 'Respuesta Incorrecta' :
                      `Posici√≥n: ${myPosition}¬∞`}
                  </p>
                  <p class="text-gray-600">
                    ${myResponse.status === 'waiting' ? 'Esperando validaci√≥n del anfitri√≥n...' :
                      myResponse.status === 'correct' ? '¬°Sumaste puntos!' :
                      'Sigue participando'}
                  </p>
                </div>
              ` : `
                <button
                  onclick="playerResponse()"
                  class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white py-8 rounded-2xl font-bold text-2xl hover:shadow-2xl transform hover:scale-105 transition-all active:scale-95"
                >
                  üöÄ ¬°RESPONDER!
                </button>
              `
            ) : gameState.currentQuestion ? `
              <div class="text-center py-8">
                <p class="text-gray-600 text-lg mb-4">Pregunta cerrada</p>
                <p class="text-sm text-gray-500">Esperando siguiente pregunta...</p>
              </div>
            ` : ''}

            <div class="mt-6 p-4 bg-purple-100 rounded-xl text-center">
              <p class="text-gray-700 mb-1">Tu Puntuaci√≥n</p>
              <p class="text-3xl font-bold text-purple-600">${gameState.scores[playerName] || 0} pts</p>
            </div>
          </div>
        </div>
      `;
    }

    function setMode(newMode) {
      mode = newMode;
      render();
    }

    function promptHostPassword() {
      setMode('host');
    }

    function renderHostLogin() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 flex items-center justify-center p-4">
          <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-6">
              <div class="text-6xl mb-4">üîê</div>
              <h2 class="text-3xl font-bold text-gray-800 mb-2">Acceso de Anfitri√≥n</h2>
              <p class="text-gray-600">Ingresa la contrase√±a para continuar</p>
            </div>
            
            <div id="errorMessage" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm text-center">
              Contrase√±a incorrecta
            </div>
            
            <input
              type="password"
              id="hostPasswordInput"
              placeholder="Contrase√±a"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl mb-4 focus:border-purple-500 focus:outline-none text-lg"
              onkeypress="if(event.key === 'Enter') checkHostPassword()"
            />
            
            <button
              onclick="checkHostPassword()"
              class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl font-semibold text-lg hover:shadow-lg transition-all"
            >
              Entrar
            </button>
            
            <button
              onclick="setMode('choose'); isHostAuthenticated = false;"
              class="w-full mt-3 px-4 py-2 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300"
            >
              Volver
            </button>
          </div>
        </div>
      `;
    }

    function checkHostPassword() {
      const input = document.getElementById('hostPasswordInput');
      const errorMessage = document.getElementById('errorMessage');
      
      if (input.value === 'Marco') {
        isHostAuthenticated = true;
        render();
      } else {
        errorMessage.classList.remove('hidden');
        input.value = '';
        input.focus();
        setTimeout(() => {
          errorMessage.classList.add('hidden');
        }, 3000);
      }
    }

    function submitName() {
      const input = document.getElementById('nameInput');
      if (input.value.trim()) {
        playerName = input.value.trim();
        hasResponded = false;
        socket.emit('registerPlayer', playerName);
        render();
      }
    }

    function changeName() {
      playerName = '';
      hasResponded = false;
      render();
    }

    function launchQuestion() {
      startQuestion('Pregunta #' + (gameState.questionNumber + 1));
    }

    render();
  </script>
</body>
</html>